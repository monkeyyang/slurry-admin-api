# 账号可用性检查系统

## 功能概述

这个系统用于定期检查各个面额（50-500美元，以50为基数）的可兑换账号数量，帮助监控账号池的可用性状况。

## 核心特性

### 📊 面额检查范围
- **面额列表**: $50, $100, $150, $200, $250, $300, $350, $400, $450, $500
- **智能筛选**: 考虑账号状态、登录状态、当日计划剩余额度

### 🎯 检查条件

#### 账号基础条件
- 状态为 `processing`
- 登录状态为 `valid` 
- 未被软删除

#### 统计数据说明
- **面额可用性统计**: 仅统计 `processing` 状态且登录有效的账号（因为只有这些账号可以立即进行兑换）
- **详细统计信息**: 包含 `processing` 和 `waiting` 状态的账号（提供更全面的账号池状况）
  - 零余额账号统计
  - 有计划/无计划账号统计  
  - 余额分布统计

#### 特殊规则
- **零余额账号**: 如果账号余额为0，可兑换所有面额
- **总额度检查**: 当前余额 + 兑换金额 ≤ 计划总额度
- **当日额度检查**: 当日剩余可兑换 ≥ 所需面额

#### 当日额度计算
```
当日最大可兑换 = 计划金额 + 浮动金额
当日剩余可兑换 = 当日最大可兑换 - 当日已兑换金额
```

## 使用方法

### 手动执行

```bash
# 检查所有国家的账号可用性
php artisan itunes:check-available-accounts

# 检查指定国家
php artisan itunes:check-available-accounts --country=US

# 检查多个国家
php artisan itunes:check-available-accounts --country=US --country=CA --country=GB

# 查看帮助信息
php artisan itunes:check-available-accounts --help
```

### 自动调度

该命令已配置为每30分钟自动执行：

```php
// 在 app/Console/Kernel.php 中配置
$schedule->command('itunes:check-available-accounts')
        ->everyThirtyMinutes()
        ->name('check_available_accounts_by_amount')
        ->withoutOverlapping()
        ->runInBackground()
        ->appendOutputTo(storage_path('logs/itunes_available_accounts.log'));
```

## 输出示例

```
🔍 开始检查各个面额可兑换的账号数量
检查国家: US, CA, GB

📊 检查国家: US
  总账号数: 45
  面额 $ 50:  42 个账号
  面额 $100:  38 个账号
  面额 $150:  35 个账号
  面额 $200:  32 个账号
  面额 $250:  28 个账号
  面额 $300:  25 个账号
  面额 $350:  20 个账号
  面额 $400:  15 个账号
  面额 $450:  10 个账号
  面额 $500:   8 个账号
  零余额账号: 5 个（可兑换所有面额）*
  有计划账号: 40 个*
  无计划账号: 5 个*
  余额分布:*
    $0: 5 个
    $1-500: 15 个
    $501-1000: 12 个
    $1001-1500: 8 个
    $1500+: 5 个
  ⚠️  瓶颈面额: $400, $450

*注: 标记*的统计数据包含processing和waiting状态的账号
```

## 详细分析功能

### 📈 统计指标

1. **总账号数**: 符合基础条件的账号总数（仅processing状态）
2. **面额可用性**: 每个面额的可兑换账号数量（仅processing状态）
3. **零余额账号**: 可兑换所有面额的账号数量（包含processing和waiting状态）
4. **计划绑定**: 有计划vs无计划账号分布（包含processing和waiting状态）
5. **余额分布**: 账号余额区间分布（包含processing和waiting状态）
6. **瓶颈识别**: 识别可用账号数量显著下降的面额

### 🚨 瓶颈面额识别

系统会自动识别瓶颈面额，条件为：
- 相比上一个面额，可用账号数减少超过20%
- 且当前面额可用账号数少于10个

## 微信通知功能

### 📱 自动通知

检查完成后，系统会自动将结果发送到微信群，方便及时了解账号可用性状况。

### 📨 通知内容

微信消息格式示例：

```
可用账号监控
---------------------
检测时间: 2024-01-15 14:30:00
执行耗时: 1250ms

 📊 国家: US
 总账号数: 45
   $ 50:  42 个
   $100:  38 个
   $150:  35 个
   $200:  32 个
   $250:  28 个
   $300:  25 个
   $350:  20 个
   $400:  15 个
   $450:  10 个
   $500:   8 个
 ⚠️ 瓶颈面额: $400, $450
 零余额账号: 5 个（可兑换所有面额）
 有计划账号: 40 个
 无计划账号: 5 个
 余额分布:
   0: 5 个
   1-500: 15 个
   501-1000: 12 个
   1001-1500: 8 个
   1500+: 5 个

 📊 国家: CA
 总账号数: 23
   $ 50:  20 个
   $100:  18 个
   $150:  15 个
   $200:  12 个
   $250:  10 个
   $300:   8 个
   $350:   6 个
   $400:   4 个
   $450:   2 个
   $500:   1 个
 ⚠️ 瓶颈面额: $400, $450, $500
 零余额账号: 3 个（可兑换所有面额）
 有计划账号: 20 个
 无计划账号: 3 个
 余额分布:
   0: 3 个
   1-500: 8 个
   501-1000: 5 个
   1001-1500: 4 个
      1500+: 3 个
 
 注: 零余额账号、有计划账号、无计划账号和余额分布统计包含processing和waiting状态的账号
 ```

### 🎯 通知目标

- **微信群**: 45958721463@chatroom（管理群）
- **发送频率**: 每30分钟执行检查后自动发送
- **异常处理**: 发送失败时记录错误日志

### ⚙️ 配置说明

如需修改通知目标群，请在 `CheckAvailableAccountsByAmount.php` 中修改：

```php
// 修改微信群ID
$roomId = '45958721463@chatroom'; // 替换为目标群ID
```

## 日志记录

### 日志文件位置
- **调度执行日志**: `storage/logs/itunes_available_accounts.log`
- **系统日志**: `storage/logs/kernel_process_accounts.log`

### 日志内容示例

```json
{
  "message": "账号可用性统计",
  "context": {
    "country": "US",
    "total_accounts": 45,
    "statistics": {
      "50": 42,
      "100": 38,
      "150": 35,
      "200": 32,
      "250": 28,
      "300": 25,
      "350": 20,
      "400": 15,
      "450": 10,
      "500": 8
    }
  }
}
```

### 微信发送日志

```json
{
  "message": "检测结果发送到微信成功",
  "context": {
    "room_id": "45958721463@chatroom",
    "message_length": 486
  }
}
```

## 性能优化

### 🚀 优化策略

1. **分国家处理**: 按国家分组处理，避免内存占用过高
2. **关联预加载**: 使用 `with('plan')` 预加载计划信息
3. **批量查询**: 避免在循环中执行N+1查询
4. **内存管理**: 处理完一个国家后释放内存

### ⏱️ 执行时间

- **单国家处理时间**: 通常 < 1秒（100个账号以内）
- **总执行时间**: 取决于国家数量和账号总数
- **内存占用**: 每个国家约 2-5MB

## 监控告警

### 📱 建议监控指标

1. **零可用账号**: 某个面额完全无可用账号
2. **可用性急剧下降**: 相比上次检查，可用账号数大幅减少
3. **执行失败**: 命令执行异常或超时
4. **瓶颈面额增加**: 瓶颈面额数量增加

### 🔔 告警阈值建议

- 可用账号数 < 5: 高风险
- 可用账号数 < 10: 中风险  
- 瓶颈面额 > 3个: 需要关注

## 故障排查

### 常见问题

1. **命令执行失败**
   - 检查数据库连接
   - 检查模型关联关系
   - 查看错误日志

2. **统计结果异常**
   - 检查账号状态是否正确
   - 验证计划配置
   - 检查兑换日志记录

3. **性能问题**
   - 检查数据库索引
   - 考虑分批处理
   - 监控内存使用

### 调试模式

```bash
# 启用详细输出
php artisan itunes:check-available-accounts -v

# 查看具体错误
php artisan itunes:check-available-accounts --country=US 2>&1 | tee debug.log
```

## 扩展功能

### 未来改进方向

1. **实时监控面板**: Web界面显示实时统计
2. **历史趋势分析**: 保存历史数据，分析趋势
3. **自动告警系统**: 集成邮件/短信通知
4. **更细粒度分析**: 按计划类型、群组等维度分析
5. **预测分析**: 基于历史数据预测账号需求

## 测试

运行测试脚本验证功能：

```bash
php test_check_accounts.php
```

该脚本会测试命令的基本功能和参数处理。

---

**维护说明**: 该功能每30分钟自动执行，无需人工干预。如需调整检查频率或面额范围，请修改相应配置文件。 