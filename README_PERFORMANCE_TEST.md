# FindAccountService 性能测试文档

## 📋 测试概述

这是一个专门用于测试 `FindAccountService` 交集筛选性能的脚本，验证新的高性能账号筛选算法。

## 🎯 测试参数

- **国家**: CA (加拿大)
- **金额**: 200
- **计划ID**: 1
- **房间ID**: 50165570842@chatroom
- **当前天数**: 1

## 🚀 使用方法

### 1. 直接运行

```bash
php test_find_account_performance.php
```

### 2. 通过artisan运行（推荐）

```bash
php artisan tinker
```

然后在tinker中执行：
```php
require_once 'test_find_account_performance.php';
```

## 📊 测试内容

### 1. 基础信息统计
- 数据库中CA国家的账号分布统计
- 计划相关的账号绑定情况
- 账号状态和登录状态分布

### 2. 各层筛选性能分析
- **第1层**: 基础条件筛选（状态、登录、国家、总额度）
- **第2层**: 礼品卡约束筛选（倍数、固定面额等）
- **第3层**: 群聊绑定筛选
- **第4层**: 容量检查筛选（充满/预留逻辑）
- **第5层**: 每日计划筛选

### 3. 实际账号查找测试
- 执行5轮真实的账号查找
- 统计成功率、平均耗时、最优最差时间
- 记录找到的账号信息

### 4. 并发性能模拟
- 模拟10个并发请求
- 使用不同金额（200, 250, 300）
- 计算理论QPS和成功率

## 📈 性能等级标准

- **S级🏆**: < 30ms
- **A级🥇**: < 100ms  
- **B级🥈**: >= 100ms

## 🔧 输出示例

```
========================================
FindAccountService 性能测试开始
========================================

📋 测试参数：
  - 国家：CA
  - 金额：200
  - 计划ID：1
  - 房间ID：50165570842@chatroom
  - 当前天数：1

📋 获取计划信息...
  - 计划名称：CA礼品卡兑换计划
  - 计划国家：CA
  - 总额度：2000
  - 计划天数：7
  - 绑定群聊：是
  - 汇率约束：multiple
    * 倍数基数：50
    * 最小金额：150
    * 最大金额：500

📊 基础统计信息：
  - 总账号数：150
  - Processing状态：120
  - 有效登录：100
  - 绑定到此计划：25
  - 未绑定计划：75
  - 零金额账号：10
  - 有余额账号：90
  - 平均余额：850.50
  - 最大余额：1800

🚀 执行详细性能分析：
  📈 各层筛选结果：
    第1层-基础条件：45 个账号，耗时 8.2ms
    第2层-约束条件：45 个账号，耗时 0.5ms
    第3层-群聊绑定：30 个账号，耗时 2.1ms
    第4层-容量检查：25 个账号，耗时 3.8ms
    第5层-每日计划：20 个账号，耗时 5.2ms

  🎯 最终结果：
    - 最终合格账号：20 个
    - 总耗时：19.8ms
    - 性能等级：S级🏆

🎯 实际账号查找测试：
  执行 5 轮账号查找测试...
    第1轮：✅ 找到账号 #123，耗时 22.5ms
    第2轮：✅ 找到账号 #156，耗时 18.3ms
    第3轮：✅ 找到账号 #189，耗时 21.7ms
    第4轮：✅ 找到账号 #123，耗时 19.1ms
    第5轮：✅ 找到账号 #156，耗时 20.8ms

  📊 多轮测试统计：
    - 成功率：5/5 (100.0%)
    - 平均耗时：20.5ms
    - 最优耗时：18.3ms
    - 最差耗时：22.5ms
    - 找到的账号：
      * #123 (user123@example.com) 余额:1200
      * #156 (user156@example.com) 余额:1500
      * #189 (user189@example.com) 余额:900

⚡ 并发性能模拟测试：
  模拟高并发场景（10个并发请求）...

  📊 并发测试结果：
    - 总请求数：10
    - 成功请求：8
    - 成功率：80.0%
    - 总耗时：195.6ms
    - 平均单请求耗时：19.6ms
    - 理论QPS：51.0 请求/秒
    - 详细结果：
      请求1 (金额:200) ✅ 22.1ms -> 账号#123
      请求2 (金额:250) ✅ 18.9ms -> 账号#156
      请求3 (金额:300) ❌ 15.2ms
      ...

========================================
性能测试完成
========================================
```

## ⚠️ 注意事项

1. **数据库连接**: 确保数据库连接正常
2. **数据准备**: 确保有足够的测试数据
3. **权限**: 确保有读取数据库的权限
4. **环境**: 建议在测试环境中运行

## 🐛 故障排除

### 找不到计划ID
```
❌ 错误：找不到计划ID 1
```
**解决**: 检查数据库中是否存在ID为1的计划，或修改测试参数中的plan_id。

### 数据库连接失败
```
❌ 测试过程中发生异常：Database connection failed
```
**解决**: 检查`.env`文件中的数据库配置。

### 没有找到符合条件的账号
这是正常情况，可能的原因：
- 当前数据库中没有CA国家的账号
- 所有账号都不满足筛选条件
- 账号都已被锁定或状态不正确

## 📞 技术支持

如果遇到问题，请检查：
1. Laravel应用配置是否正确
2. 数据库中是否有相应的测试数据
3. `FindAccountService`类是否正确加载
4. 相关模型文件是否存在 