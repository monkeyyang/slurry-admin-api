# æ™ºèƒ½é¢„ç•™åˆ¤æ–­åŠŸèƒ½è¯´æ˜

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

`FindAccountService` æ–°å¢äº†æ™ºèƒ½é¢„ç•™åˆ¤æ–­åŠŸèƒ½ï¼Œèƒ½å¤Ÿåœ¨æŸ¥æ‰¾å¯ç”¨è´¦å·æ—¶è‡ªåŠ¨åˆ¤æ–­è´¦å·æ˜¯å¦é€‚åˆå…‘æ¢æŒ‡å®šé‡‘é¢çš„ç¤¼å“å¡ï¼Œç¡®ä¿å…‘æ¢åè´¦å·ä½™é¢èƒ½å¤Ÿæ»¡è¶³é¢„ç•™è¦æ±‚ã€‚

## ğŸ§  æ ¸å¿ƒé€»è¾‘

### 1. å››å±‚éªŒè¯æœºåˆ¶

```
ç¬¬ä¸€å±‚ï¼šç¤¼å“å¡åŸºæœ¬çº¦æŸéªŒè¯
    â†“ é€šè¿‡
ç¬¬äºŒå±‚ï¼šæ€»é¢åº¦éªŒè¯ï¼ˆè´¦å·ä½™é¢ + ç¤¼å“å¡é‡‘é¢ â‰¤ è®¡åˆ’æ€»é¢åº¦ï¼‰
    â†“ é€šè¿‡  
ç¬¬ä¸‰å±‚ï¼šå……æ»¡/é¢„ç•™éªŒè¯ï¼ˆåŸºäºè®¡åˆ’æ€»é¢åº¦çš„æ™ºèƒ½é¢„ç•™åˆ¤æ–­ï¼‰
    â†“ é€šè¿‡
ç¬¬å››å±‚ï¼šæ¯æ—¥è®¡åˆ’éªŒè¯ï¼ˆæœ€åä¸€å¤©å¯è·³è¿‡ï¼‰
    â†“ é€šè¿‡ï¼šè´¦å·å¯ç”¨
    â†“ å¤±è´¥ï¼šæ›´æ¢è´¦å·
```

### 2. è®¡åˆ’ç»‘å®šç­–ç•¥

| è´¦å·çŠ¶æ€ | ä½¿ç”¨è®¡åˆ’ | è¯´æ˜ |
|---------|---------|------|
| å·²ç»‘å®šå½“å‰è®¡åˆ’ | å½“å‰è®¡åˆ’ | ä½¿ç”¨è´¦å·å½“å‰å¤©æ•°å’Œè¿›åº¦ |
| ç»‘å®šå…¶ä»–è®¡åˆ’ | å…¶ä»–è®¡åˆ’ | è·å–è´¦å·ç»‘å®šçš„è®¡åˆ’ä¿¡æ¯ |
| æœªç»‘å®šè®¡åˆ’ | å½“å‰è®¡åˆ’ | é»˜è®¤ä¸ºç¬¬1å¤©ï¼Œä½¿ç”¨å½“å‰è®¡åˆ’çº¦æŸ |

## ğŸ“Š çº¦æŸç±»å‹è¯¦è§£

### å€æ•°çº¦æŸ (MULTIPLE)

**è§„åˆ™ï¼š** 
- å€æ•°åŸºæ•°ï¼šé€šå¸¸ä¸º50
- æœ€å°é¢„ç•™ï¼š150å…ƒï¼ˆæˆ–å€æ•°åŸºæ•°ï¼Œå–è¾ƒå¤§å€¼ï¼‰
- é¢„ç•™é‡‘é¢å¿…é¡»æ˜¯å€æ•°çš„æ•´æ•°å€

**ç¤ºä¾‹ï¼š**
```
ç¤¼å“å¡ï¼š1650å…ƒï¼Œè®¡åˆ’æ€»é¢ï¼š1500å…ƒï¼Œè´¦å·ä½™é¢ï¼š1000å…ƒ
éœ€è¦å……æ»¡ï¼š1500-1000=500å…ƒï¼Œè¶…å‡ºï¼š1650-500=1150å…ƒ
- 1150å…ƒ â‰¥ 150å…ƒï¼ˆæœ€å°è¦æ±‚ï¼‰â†’ é€šè¿‡
- 1150å…ƒ % 50 = 0ï¼ˆç¬¦åˆå€æ•°ï¼‰â†’ é€šè¿‡

ç¤¼å“å¡ï¼š1675å…ƒï¼Œè®¡åˆ’æ€»é¢ï¼š1500å…ƒï¼Œè´¦å·ä½™é¢ï¼š1000å…ƒ  
éœ€è¦å……æ»¡ï¼š1500-1000=500å…ƒï¼Œè¶…å‡ºï¼š1675-500=1175å…ƒ
- 1175å…ƒ â‰¥ 150å…ƒï¼ˆæœ€å°è¦æ±‚ï¼‰â†’ é€šè¿‡
- 1175å…ƒ % 50 = 25ï¼ˆä¸ç¬¦åˆå€æ•°ï¼‰â†’ å¤±è´¥
```

### å›ºå®šé¢é¢çº¦æŸ (FIXED)

**è§„åˆ™ï¼š**
- å›ºå®šé¢é¢ï¼šå¦‚[50, 100]
- é¢„ç•™é‡‘é¢å¿…é¡»ç²¾ç¡®åŒ¹é…æŸä¸ªå›ºå®šé¢é¢
- æœ€å°é¢„ç•™ä¸ºæœ€å°å›ºå®šé¢é¢

**ç¤ºä¾‹ï¼š**
```
å›ºå®šé¢é¢ï¼š[50, 100]
ç¤¼å“å¡ï¼š1550å…ƒï¼Œè®¡åˆ’æ€»é¢ï¼š1500å…ƒï¼Œè´¦å·ä½™é¢ï¼š1000å…ƒ
éœ€è¦å……æ»¡ï¼š1500-1000=500å…ƒï¼Œè¶…å‡ºï¼š1550-500=1050å…ƒ
- 1050å…ƒä¸åŒ¹é…ä»»ä½•å›ºå®šé¢é¢ â†’ å¤±è´¥

ç¤¼å“å¡ï¼š1600å…ƒï¼Œè®¡åˆ’æ€»é¢ï¼š1500å…ƒï¼Œè´¦å·ä½™é¢ï¼š1000å…ƒ
éœ€è¦å……æ»¡ï¼š1500-1000=500å…ƒï¼Œè¶…å‡ºï¼š1600-500=1100å…ƒ
- 1100å…ƒä¸åŒ¹é…ä»»ä½•å›ºå®šé¢é¢ â†’ å¤±è´¥
```

### å…¨é¢é¢çº¦æŸ (ALL)

**è§„åˆ™ï¼š**
- ä»»ä½•é‡‘é¢éƒ½å¯ä»¥é¢„ç•™
- åªè¦æœ‰è¶…å‡ºé‡‘é¢å³å¯

**ç¤ºä¾‹ï¼š**
```
ç¤¼å“å¡ï¼š1575å…ƒï¼Œè®¡åˆ’æ€»é¢ï¼š1500å…ƒï¼Œè´¦å·ä½™é¢ï¼š1000å…ƒ
éœ€è¦å……æ»¡ï¼š1500-1000=500å…ƒï¼Œè¶…å‡ºï¼š1575-500=1075å…ƒ
- 1075å…ƒ > 0 â†’ é€šè¿‡
```

## ğŸ”§ å®ç°ç»†èŠ‚

### æ ¸å¿ƒæ–¹æ³•

1. **`validateAccountConstraints()`** - å››å±‚éªŒè¯ä¸»å…¥å£
2. **`validateGiftCardConstraints()`** - ç¬¬ä¸€å±‚ï¼šç¤¼å“å¡åŸºæœ¬çº¦æŸéªŒè¯
3. **`validateTotalAmountLimit()`** - ç¬¬äºŒå±‚ï¼šæ€»é¢åº¦éªŒè¯
4. **`validateAccountReservation()`** - ç¬¬ä¸‰å±‚ï¼šæ™ºèƒ½é¢„ç•™åˆ¤æ–­
5. **`validateDailyPlanLimit()`** - ç¬¬å››å±‚ï¼šæ¯æ—¥è®¡åˆ’éªŒè¯
6. **`validateMultipleReservation()`** - å€æ•°çº¦æŸéªŒè¯
7. **`validateFixedAmountReservation()`** - å›ºå®šé¢é¢çº¦æŸéªŒè¯
8. **`validateAllAmountReservation()`** - å…¨é¢é¢çº¦æŸéªŒè¯

### å…³é”®è®¡ç®—

```php
// è®¡åˆ’æ€»é¢åº¦å¯å…‘æ¢é‡‘é¢
$currentBalance = $accountData->amount;
$totalPlanAmount = $targetPlan->total_amount;
$remainingPlanAmount = $totalPlanAmount - $currentBalance;

// è¶…å‡ºé‡‘é¢
$excessAmount = $giftCardAmount - $remainingPlanAmount;

// å…‘æ¢åä½™é¢
$afterExchangeBalance = $currentBalance + $giftCardAmount;
```

## ğŸ“ æ—¥å¿—è®°å½•

### Debugçº§åˆ«æ—¥å¿—
- è®¡åˆ’ç»‘å®šçŠ¶æ€åˆ¤æ–­
- å½“æ—¥é¢åº¦è®¡ç®—è¿‡ç¨‹
- å„ç§çº¦æŸéªŒè¯è¯¦æƒ…

### Infoçº§åˆ«æ—¥å¿—
- é¢„ç•™éªŒè¯å¤±è´¥åŸå› 
- è´¦å·é€‚ç”¨æ€§åˆ¤æ–­ç»“æœ

### Warningçº§åˆ«æ—¥å¿—
- è®¡åˆ’æˆ–æ±‡ç‡ä¿¡æ¯ç¼ºå¤±
- é…ç½®é”™è¯¯è­¦å‘Š

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### å€æ•°çº¦æŸæµ‹è¯•
```php
// æµ‹è¯•ç”¨ä¾‹1ï¼šå¯ä»¥å……æ»¡è®¡åˆ’
$giftCardAmount = 100.00; // å½“æ—¥éœ€è¦700ï¼Œå¯å®Œå…¨ä½¿ç”¨
$expected = true;

// æµ‹è¯•ç”¨ä¾‹2ï¼šéœ€è¦é¢„ç•™150
$giftCardAmount = 650.00; // è¶…å‡º50ï¼Œä¸è¶³150æœ€å°è¦æ±‚
$expected = true; // ç³»ç»Ÿä¼šè¦æ±‚é¢„ç•™150

// æµ‹è¯•ç”¨ä¾‹3ï¼šä¸ç¬¦åˆå€æ•°
$giftCardAmount = 675.00; // è¶…å‡º75ï¼Œä¸æ˜¯50çš„å€æ•°
$expected = false;
```

### å›ºå®šé¢é¢æµ‹è¯•
```php
// æµ‹è¯•ç”¨ä¾‹1ï¼šå¯ä»¥é¢„ç•™50
$giftCardAmount = 650.00; // è¶…å‡º50ï¼ŒåŒ¹é…å›ºå®šé¢é¢
$fixedAmounts = [50, 100];
$expected = true;

// æµ‹è¯•ç”¨ä¾‹2ï¼šä¸åŒ¹é…é¢é¢
$giftCardAmount = 675.00; // è¶…å‡º75ï¼Œä¸åŒ¹é…ä»»ä½•é¢é¢
$expected = false;
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. é¢„è®¡ç®—ä¼˜åŒ–
- åœ¨SQLæŸ¥è¯¢é˜¶æ®µå°±åŒ…å«`daily_spent`è®¡ç®—
- é¿å…åœ¨éªŒè¯é˜¶æ®µé‡å¤æŸ¥è¯¢æ•°æ®åº“

### 2. æ—©æœŸé€€å‡º
- èƒ½å……æ»¡è®¡åˆ’æ—¶ç«‹å³è¿”å›true
- å‡å°‘ä¸å¿…è¦çš„å¤æ‚è®¡ç®—

### 3. ç¼“å­˜æœºåˆ¶
- è®¡åˆ’ä¿¡æ¯åœ¨éªŒè¯è¿‡ç¨‹ä¸­å¤ç”¨
- é¿å…é‡å¤è·å–ç›¸åŒè®¡åˆ’æ•°æ®

## ğŸ”„ é›†æˆæ–¹å¼

### åœ¨GiftCardServiceä¸­ä½¿ç”¨
```php
// åŸæ¥çš„è°ƒç”¨æ–¹å¼ï¼ˆå·²æ³¨é‡Šï¼‰
// $account = $this->findAvailableAccount($plan, $this->roomId, $giftCardInfo);

// æ–°çš„è°ƒç”¨æ–¹å¼
$account = $this->findAccountService->findAvailableAccount(
    $plan, 
    $this->roomId, 
    $giftCardInfo,
    1,  // å½“å‰å¤©æ•°
    3   // æœ€å¤§é‡è¯•æ¬¡æ•°
);
```

### é‡è¯•æœºåˆ¶
- å½“è´¦å·ä¸ç¬¦åˆé¢„ç•™è¦æ±‚æ—¶ï¼Œè‡ªåŠ¨å°è¯•ä¸‹ä¸€ä¸ªè´¦å·
- æœ€å¤šé‡è¯•3æ¬¡ï¼Œé¿å…æ— é™å¾ªç¯
- æ¯æ¬¡é‡è¯•æ’é™¤å·²éªŒè¯å¤±è´¥çš„è´¦å·

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### æˆåŠŸç‡æŒ‡æ ‡
- é¢„ç•™éªŒè¯é€šè¿‡ç‡
- è´¦å·æŸ¥æ‰¾æˆåŠŸç‡
- é‡è¯•æ¬¡æ•°åˆ†å¸ƒ

### æ€§èƒ½æŒ‡æ ‡
- éªŒè¯è€—æ—¶ç»Ÿè®¡
- SQLæŸ¥è¯¢æ¬¡æ•°
- å†…å­˜ä½¿ç”¨æƒ…å†µ

### ä¸šåŠ¡æŒ‡æ ‡
- å„çº¦æŸç±»å‹ä½¿ç”¨é¢‘ç‡
- é¢„ç•™é‡‘é¢åˆ†å¸ƒ
- å¤±è´¥åŸå› åˆ†æ

## ğŸ› ï¸ é…ç½®å»ºè®®

### å€æ•°çº¦æŸé…ç½®
```php
'multiple_base' => 50,      // å€æ•°åŸºæ•°
'min_amount' => 50,         // æœ€å°é‡‘é¢
// ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—æœ€å°é¢„ç•™ä¸ºmax(150, multiple_base)
```

### å›ºå®šé¢é¢é…ç½®
```php
'fixed_amounts' => [50, 100, 200], // æ”¯æŒçš„å›ºå®šé¢é¢
// æœ€å°é¢„ç•™ä¸ºmin(fixed_amounts)
```

### å…¨é¢é¢é…ç½®
```php
'amount_constraint' => 'all', // æ— ç‰¹æ®Šé™åˆ¶
// ä»»ä½•è¶…å‡ºé‡‘é¢éƒ½å¯é¢„ç•™
```

## ğŸ¯ æœ€ä½³å®è·µ

1. **åˆç†è®¾ç½®å€æ•°åŸºæ•°**ï¼šå»ºè®®50æˆ–100ï¼Œä¾¿äºé¢„ç•™è®¡ç®—
2. **å›ºå®šé¢é¢è¦è¿ç»­**ï¼šå¦‚[50, 100, 200]ï¼Œé¿å…è·³è·ƒ
3. **ç›‘æ§é¢„ç•™å¤±è´¥ç‡**ï¼šåŠæ—¶è°ƒæ•´é…ç½®å‚æ•°
4. **å®šæœŸæ¸…ç†é”å®šè´¦å·**ï¼šé¿å…è´¦å·é•¿æœŸè¢«é”å®š
5. **æ—¥å¿—çº§åˆ«æ§åˆ¶**ï¼šç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨INFOçº§åˆ«

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **æ‰¾ä¸åˆ°å¯ç”¨è´¦å·**
   - æ£€æŸ¥è´¦å·ä½™é¢æ˜¯å¦å……è¶³
   - éªŒè¯çº¦æŸé…ç½®æ˜¯å¦åˆç†
   - ç¡®è®¤è®¡åˆ’é¢åº¦è®¾ç½®

2. **é¢„ç•™éªŒè¯æ€»æ˜¯å¤±è´¥**
   - æ£€æŸ¥å€æ•°åŸºæ•°è®¾ç½®
   - ç¡®è®¤å›ºå®šé¢é¢é…ç½®
   - éªŒè¯æœ€å°é¢„ç•™è¦æ±‚

3. **æ€§èƒ½é—®é¢˜**
   - æ£€æŸ¥SQLæŸ¥è¯¢æ•ˆç‡
   - ç›‘æ§é‡è¯•æ¬¡æ•°
   - ä¼˜åŒ–å€™é€‰è´¦å·æ•°é‡

### è°ƒè¯•æ–¹æ³•

1. **å¯ç”¨è¯¦ç»†æ—¥å¿—**
```php
Log::channel('gift_card_exchange')->debug('è°ƒè¯•ä¿¡æ¯', $data);
```

2. **ä½¿ç”¨æµ‹è¯•è„šæœ¬**
```bash
php test_smart_reservation.php
```

3. **ç›‘æ§å…³é”®æŒ‡æ ‡**
- æ‰§è¡Œæ—¶é—´
- æˆåŠŸç‡
- é‡è¯•æ¬¡æ•° 