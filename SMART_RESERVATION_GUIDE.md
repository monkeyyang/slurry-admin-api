# 智能预留判断功能说明

## 🎯 功能概述

`FindAccountService` 新增了智能预留判断功能，能够在查找可用账号时自动判断账号是否适合兑换指定金额的礼品卡，确保兑换后账号余额能够满足预留要求。

## 🧠 核心逻辑

### 1. 四层验证机制

```
第一层：礼品卡基本约束验证
    ↓ 通过
第二层：总额度验证（账号余额 + 礼品卡金额 ≤ 计划总额度）
    ↓ 通过  
第三层：充满/预留验证（基于计划总额度的智能预留判断）
    ↓ 通过
第四层：每日计划验证（最后一天可跳过）
    ↓ 通过：账号可用
    ↓ 失败：更换账号
```

### 2. 计划绑定策略

| 账号状态 | 使用计划 | 说明 |
|---------|---------|------|
| 已绑定当前计划 | 当前计划 | 使用账号当前天数和进度 |
| 绑定其他计划 | 其他计划 | 获取账号绑定的计划信息 |
| 未绑定计划 | 当前计划 | 默认为第1天，使用当前计划约束 |

## 📊 约束类型详解

### 倍数约束 (MULTIPLE)

**规则：** 
- 倍数基数：通常为50
- 最小预留：150元（或倍数基数，取较大值）
- 预留金额必须是倍数的整数倍

**示例：**
```
礼品卡：1650元，计划总额：1500元，账号余额：1000元
需要充满：1500-1000=500元，超出：1650-500=1150元
- 1150元 ≥ 150元（最小要求）→ 通过
- 1150元 % 50 = 0（符合倍数）→ 通过

礼品卡：1675元，计划总额：1500元，账号余额：1000元  
需要充满：1500-1000=500元，超出：1675-500=1175元
- 1175元 ≥ 150元（最小要求）→ 通过
- 1175元 % 50 = 25（不符合倍数）→ 失败
```

### 固定面额约束 (FIXED)

**规则：**
- 固定面额：如[50, 100]
- 预留金额必须精确匹配某个固定面额
- 最小预留为最小固定面额

**示例：**
```
固定面额：[50, 100]
礼品卡：1550元，计划总额：1500元，账号余额：1000元
需要充满：1500-1000=500元，超出：1550-500=1050元
- 1050元不匹配任何固定面额 → 失败

礼品卡：1600元，计划总额：1500元，账号余额：1000元
需要充满：1500-1000=500元，超出：1600-500=1100元
- 1100元不匹配任何固定面额 → 失败
```

### 全面额约束 (ALL)

**规则：**
- 任何金额都可以预留
- 只要有超出金额即可

**示例：**
```
礼品卡：1575元，计划总额：1500元，账号余额：1000元
需要充满：1500-1000=500元，超出：1575-500=1075元
- 1075元 > 0 → 通过
```

## 🔧 实现细节

### 核心方法

1. **`validateAccountConstraints()`** - 四层验证主入口
2. **`validateGiftCardConstraints()`** - 第一层：礼品卡基本约束验证
3. **`validateTotalAmountLimit()`** - 第二层：总额度验证
4. **`validateAccountReservation()`** - 第三层：智能预留判断
5. **`validateDailyPlanLimit()`** - 第四层：每日计划验证
6. **`validateMultipleReservation()`** - 倍数约束验证
7. **`validateFixedAmountReservation()`** - 固定面额约束验证
8. **`validateAllAmountReservation()`** - 全面额约束验证

### 关键计算

```php
// 计划总额度可兑换金额
$currentBalance = $accountData->amount;
$totalPlanAmount = $targetPlan->total_amount;
$remainingPlanAmount = $totalPlanAmount - $currentBalance;

// 超出金额
$excessAmount = $giftCardAmount - $remainingPlanAmount;

// 兑换后余额
$afterExchangeBalance = $currentBalance + $giftCardAmount;
```

## 📝 日志记录

### Debug级别日志
- 计划绑定状态判断
- 当日额度计算过程
- 各种约束验证详情

### Info级别日志
- 预留验证失败原因
- 账号适用性判断结果

### Warning级别日志
- 计划或汇率信息缺失
- 配置错误警告

## 🧪 测试用例

### 倍数约束测试
```php
// 测试用例1：可以充满计划
$giftCardAmount = 100.00; // 当日需要700，可完全使用
$expected = true;

// 测试用例2：需要预留150
$giftCardAmount = 650.00; // 超出50，不足150最小要求
$expected = true; // 系统会要求预留150

// 测试用例3：不符合倍数
$giftCardAmount = 675.00; // 超出75，不是50的倍数
$expected = false;
```

### 固定面额测试
```php
// 测试用例1：可以预留50
$giftCardAmount = 650.00; // 超出50，匹配固定面额
$fixedAmounts = [50, 100];
$expected = true;

// 测试用例2：不匹配面额
$giftCardAmount = 675.00; // 超出75，不匹配任何面额
$expected = false;
```

## 🚀 性能优化

### 1. 预计算优化
- 在SQL查询阶段就包含`daily_spent`计算
- 避免在验证阶段重复查询数据库

### 2. 早期退出
- 能充满计划时立即返回true
- 减少不必要的复杂计算

### 3. 缓存机制
- 计划信息在验证过程中复用
- 避免重复获取相同计划数据

## 🔄 集成方式

### 在GiftCardService中使用
```php
// 原来的调用方式（已注释）
// $account = $this->findAvailableAccount($plan, $this->roomId, $giftCardInfo);

// 新的调用方式
$account = $this->findAccountService->findAvailableAccount(
    $plan, 
    $this->roomId, 
    $giftCardInfo,
    1,  // 当前天数
    3   // 最大重试次数
);
```

### 重试机制
- 当账号不符合预留要求时，自动尝试下一个账号
- 最多重试3次，避免无限循环
- 每次重试排除已验证失败的账号

## 📊 监控指标

### 成功率指标
- 预留验证通过率
- 账号查找成功率
- 重试次数分布

### 性能指标
- 验证耗时统计
- SQL查询次数
- 内存使用情况

### 业务指标
- 各约束类型使用频率
- 预留金额分布
- 失败原因分析

## 🛠️ 配置建议

### 倍数约束配置
```php
'multiple_base' => 50,      // 倍数基数
'min_amount' => 50,         // 最小金额
// 系统自动计算最小预留为max(150, multiple_base)
```

### 固定面额配置
```php
'fixed_amounts' => [50, 100, 200], // 支持的固定面额
// 最小预留为min(fixed_amounts)
```

### 全面额配置
```php
'amount_constraint' => 'all', // 无特殊限制
// 任何超出金额都可预留
```

## 🎯 最佳实践

1. **合理设置倍数基数**：建议50或100，便于预留计算
2. **固定面额要连续**：如[50, 100, 200]，避免跳跃
3. **监控预留失败率**：及时调整配置参数
4. **定期清理锁定账号**：避免账号长期被锁定
5. **日志级别控制**：生产环境建议使用INFO级别

## 🔍 故障排查

### 常见问题

1. **找不到可用账号**
   - 检查账号余额是否充足
   - 验证约束配置是否合理
   - 确认计划额度设置

2. **预留验证总是失败**
   - 检查倍数基数设置
   - 确认固定面额配置
   - 验证最小预留要求

3. **性能问题**
   - 检查SQL查询效率
   - 监控重试次数
   - 优化候选账号数量

### 调试方法

1. **启用详细日志**
```php
Log::channel('gift_card_exchange')->debug('调试信息', $data);
```

2. **使用测试脚本**
```bash
php test_smart_reservation.php
```

3. **监控关键指标**
- 执行时间
- 成功率
- 重试次数 