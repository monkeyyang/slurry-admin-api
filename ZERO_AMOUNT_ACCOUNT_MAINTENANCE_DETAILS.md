# 零余额账号维护明细显示增强

## 概述

对 `ProcessItunesAccounts.php` 和 `ProcessItunesAccountsV2.php` 中的零余额账号维护功能进行了全面的明细显示增强，现在可以详细展示每个维护步骤和涉及的具体账号。

## 主要改进

### 1. 当前零余额账号状态展示

#### 增强前：
```
当前零余额且登录有效的账号数量: 15
```

#### 增强后：
```
📊 当前零余额且登录有效的账号统计
✅ 当前零余额登录账号明细 (15个)：
   1. user1@example.com (ID: 123, 国家: US)
   2. user2@example.com (ID: 124, 国家: CA)
   3. user3@example.com (ID: 125, 国家: GB)
   ...
```

### 2. 候选账号详细信息

#### 增强前：
```
找到 8 个候选登录账号
```

#### 增强后：
```
🔍 找到候选登录账号
📋 候选登录账号明细 (8个)：
   1. candidate1@example.com (ID: 201, 国家: US, 导入: 3天前)
   2. candidate2@example.com (ID: 202, 国家: CA, 导入: 5天前)
   3. candidate3@example.com (ID: 203, 国家: GB, 导入: 7天前)
   ...
```

### 3. 批量登录任务详情

#### 增强前：
```
零余额账号登录任务创建成功，任务ID: task_123
```

#### 增强后：
```
🚀 开始批量登录零余额账号
📝 准备登录数据: 1. candidate1@example.com
📝 准备登录数据: 2. candidate2@example.com
📡 发起零余额账号批量登录API请求
📊 零余额账号批量登录API响应
✅ 零余额账号批量登录任务创建成功
🎯 零余额账号登录任务已提交:
   任务ID: task_123
   账号数量: 8
   目标成功数: 5
```

## 新增显示信息

### 1. 账号基本信息
- **账号邮箱**：完整的账号邮箱地址
- **账号ID**：数据库中的唯一标识
- **国家代码**：账号所属国家
- **导入时间**：相对于当前时间的导入天数

### 2. 统计信息
- **当前数量**：实时统计的零余额账号数量
- **目标数量**：需要维护的目标数量（50个）
- **缺口数量**：需要补充的账号数量
- **候选数量**：找到的可登录候选账号数量

### 3. 任务信息
- **任务ID**：登录任务的唯一标识
- **处理账号数**：实际提交登录的账号数量
- **目标成功数**：期望成功登录的账号数量

### 4. 详细状态信息
- **账号准备状态**：是否有密码、API URL等
- **API响应详情**：完整的API调用响应
- **错误信息**：详细的错误代码和说明

## 日志结构化改进

### 1. 使用结构化日志
```php
$this->getLogger()->info("📊 当前零余额且登录有效的账号统计", [
    'current_count' => $currentZeroAmountCount,
    'target_count' => self::TARGET_ZERO_AMOUNT_ACCOUNTS,
    'account_list' => $currentZeroAmountAccounts->pluck('account')->toArray()
]);
```

### 2. 错误信息增强
```php
$this->getLogger()->warning("❌ 未找到可用于登录的候选账号", [
    'search_criteria' => [
        'status' => 'PROCESSING',
        'login_status' => 'INVALID',
        'amount' => 0
    ],
    'suggestion' => '可能需要导入更多零余额账号或检查现有账号状态'
]);
```

## 控制台输出增强

### 1. ProcessItunesAccountsV2 中的改进
- 使用 `$this->info()` 直接在控制台显示重要信息
- 使用 emoji 图标提高可读性
- 格式化显示账号列表

### 2. DRY RUN 模式支持
```
🔍 DRY RUN: 将为以下 8 个账号创建登录任务：
   1. candidate1@example.com -> 创建登录任务
   2. candidate2@example.com -> 创建登录任务
   ...
```

## 异常情况处理

### 1. 无当前零余额账号
```
⚠️  当前没有零余额且登录有效的账号
```

### 2. 无候选账号
```
❌ 未找到可用于登录的候选账号
可能需要导入更多零余额账号或检查现有账号状态
```

### 3. API调用失败
```
❌ 创建零余额账号批量登录任务失败
错误代码: 500
错误信息: API服务暂时不可用
```

## 性能优化

### 1. 查询优化
- 使用单次查询获取账号详情而非多次count查询
- 添加适当的排序以确保处理顺序

### 2. 信息精简
- 只在需要时显示详细信息
- 使用分级日志（DEBUG/INFO/WARNING/ERROR）

## 使用建议

### 1. 监控要点
- 关注当前零余额账号的数量变化
- 检查候选账号的导入时间分布
- 监控登录任务的成功率

### 2. 问题排查
- 当无候选账号时，检查账号导入流程
- 当登录失败率高时，检查账号密码有效性
- 当API调用失败时，检查网络和服务状态

### 3. 运维建议
- 定期检查零余额账号的分布情况
- 监控各国家账号的比例
- 关注账号的老化程度（导入时间）

## 示例输出

```
=== 第1步：维护零余额账号数量 ===
📊 当前零余额且登录有效的账号统计
✅ 当前零余额登录账号明细 (45个)：
   1. us_user1@example.com (ID: 1001, 国家: US)
   2. ca_user1@example.com (ID: 1002, 国家: CA)
   ...

💰 需要补充 5 个零余额登录账号

🔍 找到候选登录账号
📋 候选登录账号明细 (10个)：
   1. new_us1@example.com (ID: 2001, 国家: US, 导入: 1天前)
   2. new_ca1@example.com (ID: 2002, 国家: CA, 导入: 2天前)
   ...

🚀 开始为候选账号创建登录任务...
✅ 零余额账号批量登录任务创建成功
🎯 零余额账号登录任务已提交:
   任务ID: task_20241215_001
   账号数量: 10
   目标成功数: 5
```

通过这些增强，运维人员现在可以清楚地看到零余额账号维护的每个细节，便于监控和问题排查。 